# AiChatBot - AI Group Chat Application
# Frontend: port 3030 (static serve via npx serve)
# Backend:  port 8030 (FastAPI + Socket.IO)

# AiChatBot frontend (token auth required)
location /aichatbot/ {
    include /Users/xuzhi/prod/gateway/config/auth-include.conf;

    rewrite ^/aichatbot/(.*)$ /$1 break;

    proxy_pass http://127.0.0.1:3030;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Forward authenticated user identity
    proxy_set_header X-Auth-User $auth_user;
    proxy_set_header X-Auth-Display-Name $auth_display_name;
    proxy_set_header X-Auth-Email $auth_email;
    proxy_set_header X-Auth-Roles $auth_roles;
}

# AiChatBot Socket.IO WebSocket (must be before /aichatbot-api/ for priority)
location /aichatbot-api/socket.io/ {
    include /Users/xuzhi/prod/gateway/config/auth-include.conf;

    rewrite ^/aichatbot-api/(.*)$ /$1 break;

    proxy_pass http://127.0.0.1:8030;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Forward authenticated user identity
    proxy_set_header X-Auth-User $auth_user;
    proxy_set_header X-Auth-Display-Name $auth_display_name;
    proxy_set_header X-Auth-Email $auth_email;
    proxy_set_header X-Auth-Roles $auth_roles;

    # Disable buffering for WebSocket
    proxy_buffering off;
    proxy_cache off;

    # Long timeouts for persistent WebSocket connections
    proxy_read_timeout 86400s;
    proxy_send_timeout 86400s;
}

# AiChatBot backend API (token auth required)
location /aichatbot-api/ {
    include /Users/xuzhi/prod/gateway/config/auth-include.conf;

    rewrite ^/aichatbot-api/(.*)$ /$1 break;

    proxy_pass http://127.0.0.1:8030;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Forward authenticated user identity
    proxy_set_header X-Auth-User $auth_user;
    proxy_set_header X-Auth-Display-Name $auth_display_name;
    proxy_set_header X-Auth-Email $auth_email;
    proxy_set_header X-Auth-Roles $auth_roles;

    # Longer timeouts for AI streaming responses
    proxy_read_timeout 300s;
    proxy_connect_timeout 75s;

    # Rate limiting for API
    limit_req zone=api burst=50 nodelay;
}
