name: Deploy to Mac Mini (PM2 + Gateway)

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - '**.md'
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests'
        required: false
        default: 'false'

jobs:
  deploy:
    name: Deploy to Mac Mini with PM2
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Mac Mini via SSH
        uses: appleboy/ssh-action@v1.0.0
        env:
          DEPLOYMENT_DIR: /Users/xuzhi/prod/aichatbot
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
        with:
          host: ${{ secrets.MAC_MINI_HOST }}
          username: ${{ secrets.MAC_MINI_USER }}
          key: ${{ secrets.MAC_MINI_SSH_KEY }}
          port: ${{ secrets.MAC_MINI_SSH_PORT || 22 }}
          command_timeout: 10m
          envs: DEPLOYMENT_DIR,DEEPSEEK_API_KEY,SECRET_KEY
          script: |
            set -e

            # Colors
            GREEN='\033[0;32m'
            YELLOW='\033[1;33m'
            RED='\033[0;31m'
            NC='\033[0m'

            echo -e "${GREEN}========================================${NC}"
            echo -e "${GREEN}ðŸš€ AiChatBot Deployment Starting${NC}"
            echo -e "${GREEN}========================================${NC}"

            # Navigate to source directory
            cd ~/AiChatBot || {
              echo -e "${RED}âŒ AiChatBot directory not found${NC}"
              exit 1
            }

            # Pull latest code
            echo -e "${YELLOW}ðŸ“¥ Pulling latest code...${NC}"
            git fetch origin
            git reset --hard origin/main
            git clean -fd

            # Run deployment script
            echo -e "${YELLOW}ðŸ”§ Running PM2 deployment script...${NC}"
            chmod +x deployment/deploy-pm2.sh
            ./deployment/deploy-pm2.sh

            # Verify deployment
            echo ""
            echo -e "${GREEN}========================================${NC}"
            echo -e "${GREEN}âœ… Deployment Verification${NC}"
            echo -e "${GREEN}========================================${NC}"

            # Wait for services to start
            sleep 5

            # Check backend
            if curl -sf http://localhost:8030/health > /dev/null; then
              echo -e "${GREEN}âœ“ Backend is healthy (port 8030)${NC}"
            else
              echo -e "${RED}âœ— Backend health check failed${NC}"
              pm2 logs aichatbot-backend --lines 20 --nostream
              exit 1
            fi

            # Check frontend
            if curl -sf -o /dev/null http://localhost:3030; then
              echo -e "${GREEN}âœ“ Frontend is serving (port 3030)${NC}"
            else
              echo -e "${RED}âœ— Frontend check failed${NC}"
              pm2 logs aichatbot-frontend --lines 20 --nostream
              exit 1
            fi

            # Check gateway
            if curl -sf http://localhost/health > /dev/null; then
              echo -e "${GREEN}âœ“ Gateway is responding${NC}"
            else
              echo -e "${YELLOW}âš  Gateway check failed (may need manual nginx restart)${NC}"
            fi

            # Display PM2 status
            echo ""
            echo -e "${YELLOW}ðŸ“Š PM2 Process Status:${NC}"
            pm2 list | grep aichatbot || pm2 list

            echo ""
            echo -e "${GREEN}========================================${NC}"
            echo -e "${GREEN}ðŸŽ‰ Deployment Completed Successfully!${NC}"
            echo -e "${GREEN}========================================${NC}"
            echo ""
            echo -e "Access your application:"
            echo -e "  â€¢ Frontend:       http://localhost:3030"
            echo -e "  â€¢ Backend:        http://localhost:8030"
            echo -e "  â€¢ Via Gateway:    http://${{ secrets.MAC_MINI_HOST }}/aichatbot/"
            echo -e "  â€¢ API via Gateway: http://${{ secrets.MAC_MINI_HOST }}/aichatbot-api/"
            echo ""

      - name: Send deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… AiChatBot deployed successfully to Mac Mini!"
            echo "ðŸŒ Access at: http://${{ secrets.MAC_MINI_HOST }}/aichatbot/"
          else
            echo "âŒ Deployment failed! Check the logs above for details."
            exit 1
          fi

      - name: Deployment summary
        if: success()
        run: |
          echo "### ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Status**: Successful" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ‘¤ **Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ  **Target**: Mac Mini at ${{ secrets.MAC_MINI_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Access Points" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: \`http://localhost:3030\`" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: \`http://localhost:8030\`" >> $GITHUB_STEP_SUMMARY
          echo "- Gateway: \`http://${{ secrets.MAC_MINI_HOST }}/aichatbot/\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Management" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# View logs" >> $GITHUB_STEP_SUMMARY
          echo "pm2 logs aichatbot" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Restart services" >> $GITHUB_STEP_SUMMARY
          echo "pm2 restart aichatbot-backend aichatbot-frontend" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
